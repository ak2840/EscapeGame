# 手機板音效優化

## 問題描述
用戶反映手機板在射擊時因為音效播放造成卡頓問題。

## 根本原因分析
1. **頻繁的音效播放**：每次射擊都會播放 `playAttack()` 音效
2. **音效重疊播放**：快速射擊時會產生多個音效同時播放
3. **音效重置開銷**：每次播放都會重置 `currentTime = 0`
4. **音效預載入不足**：手機設備音效載入可能不夠及時

## 優化措施

### 1. 音效播放頻率限制
為手機設備添加音效播放頻率限制，避免過於頻繁的音效播放：

```javascript
// 攻擊音效：限制為每100ms播放一次
if (currentTime - this.lastAttackSoundTime < 100) {
  return;
}

// 命中音效：限制為每150ms播放一次
if (currentTime - this.lastHitSoundTime < 150) {
  return;
}
```

### 2. 音效重疊播放防止
為手機設備添加音效重疊播放防止機制：

```javascript
// 檢查是否正在播放同一個音效
if (sound.playing) {
  return; // 如果正在播放，跳過
}

// 設置播放標誌
sound.playing = true;

// 設置播放完成後清除標誌
sound.addEventListener('ended', () => {
  sound.playing = false;
}, { once: true });
```

### 3. 音效預載入優化
為手機設備強制預載入所有音效：

```javascript
// 設置音效預載入
const mobileAudioElements = [
  this.attackSound, this.hitSound, this.victorySound, 
  this.gameOverSound, this.buttonClickSound, this.healSound
];

mobileAudioElements.forEach(audio => {
  if (audio) {
    audio.preload = "auto";
    audio.load(); // 強制預載入
  }
});
```

### 4. 錯誤處理優化
為音效播放失敗添加更好的錯誤處理：

```javascript
sound.play().catch((e) => {
  console.log("音效播放失敗:", e);
  if (isMobileDevice()) {
    sound.playing = false; // 播放失敗時清除標誌
  }
});
```

## 優化的音效類型
- **攻擊音效** (`playAttack`): 限制播放頻率為每100ms一次
- **命中音效** (`playHit`): 限制播放頻率為每150ms一次
- **其他音效**: 添加重疊播放防止機制

## 效果
- **減少音效重疊**：防止同一個音效同時播放多次
- **降低播放頻率**：避免過於頻繁的音效播放造成卡頓
- **提升載入速度**：音效預載入確保播放時無延遲
- **改善錯誤處理**：更好的錯誤處理避免音效系統卡死

## 測試建議
請在手機設備上測試遊戲，特別注意：
1. 快速射擊時的音效播放是否流暢
2. 音效是否會重疊播放造成卡頓
3. 音效播放是否有延遲
4. 整體遊戲性能是否改善

如果仍有音效相關的性能問題，可以考慮：
- 進一步降低音效播放頻率
- 完全禁用某些非關鍵音效
- 使用更輕量的音效文件格式 