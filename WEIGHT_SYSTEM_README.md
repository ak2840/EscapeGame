# 地圖權重系統說明

## 權重運作邏輯與修改方式

### 權重運作邏輯

1. **每張地圖圖片都可以設定一個「權重」數值**，權重越高，該圖片在地圖上被選中的機率就越大。
2. **地圖生成時，每一格都會根據權重進行隨機選擇**，這是「帶權重」的隨機（不是平均分配）。
3. **演算法流程**：
   - 先把所有圖片的權重加總，得到「總權重」。
   - 針對每一格，根據該格的種子亂數，產生一個 0~1 的隨機值。
   - 依序累加每張圖片的權重，當累積權重比例超過這個隨機值時，該圖片就被選中。
   - 權重越高的圖片，被選中的機率就越高。

#### 例子
假設有6張圖片，權重如下：
- 圖片1：3
- 圖片2~6：1

總權重 = 3 + 1 + 1 + 1 + 1 + 1 = 8

- 圖片1出現機率 = 3/8 = 37.5%
- 其他每張圖片出現機率 = 1/8 = 12.5%

---

### 權重修改方式

#### 1. 修改 `levelConfig.json` 設定檔

找到你要調整的關卡，例如第1關：

```json
"1": {
  "name": "新手關卡",
  "mapWidth": 2400,
  "mapHeight": 1800,
  ...
  "mapTiles": [
    { "path": "assets/maps/map-level1-1.png", "weight": 3 },
    { "path": "assets/maps/map-level1-2.png", "weight": 1 },
    { "path": "assets/maps/map-level1-3.png", "weight": 1 },
    { "path": "assets/maps/map-level1-4.png", "weight": 1 },
    { "path": "assets/maps/map-level1-5.png", "weight": 1 },
    { "path": "assets/maps/map-level1-6.png", "weight": 1 }
  ]
}
```

#### 2. 權重調整建議

- **想讓某張圖片出現更多**：把它的 `weight` 設大一點（例如 3、5、10）。
- **想讓某張圖片很稀有**：把它的 `weight` 設小一點（例如 1）。
- **全部平均分配**：全部設成 1。

#### 3. 多關卡可分別設定

每一關的 `mapTiles` 權重可以獨立設定，不會互相影響。

---

### 如何驗證權重效果？

1. 進入遊戲後，打開 F12 輸入 `showMapWeightStats()`，可以看到每張圖片實際出現的次數與比例。
2. 或用 `test-weight.html`、`test-randomness.html` 頁面，直接測試權重分布與隨機性。

---

### 小提醒

- 權重必須是正整數，建議不要用0或負數。
- 權重越大，該圖片出現的機率越高。
- 權重比例只影響「相對機率」，不用擔心總和多大。

---

（本章節可直接複製到其他專案文件或 README 使用）

---

## 概述

「末日ESG小尖兵」遊戲現在支援地圖圖片的權重選擇系統，讓您可以控制不同地圖圖片在地圖中的出現機率。

## 功能特點

### 1. 權重配置
- 每張地圖圖片可以設定不同的權重值
- 權重值越大，該圖片出現的機率越高
- 支援向後相容性（舊的字串格式仍然有效）

### 2. 固定佈局
- 使用種子算法確保每次生成相同的地圖佈局
- 地圖佈局在遊戲開始時確定，不會在遊戲過程中改變
- 提供穩定的遊戲體驗

### 3. 統計功能
- 提供調試函數來查看權重統計
- 可以分析地圖中各種圖片的實際出現比例

## 配置格式

### 新的權重格式
```json
{
  "mapTiles": [
    {
      "path": "assets/maps/map-level1-1.png",
      "weight": 3
    },
    {
      "path": "assets/maps/map-level1-2.png",
      "weight": 1
    }
  ]
}
```

### 舊的字串格式（仍然支援）
```json
{
  "mapTiles": [
    "assets/maps/map-level1-1.png",
    "assets/maps/map-level1-2.png"
  ]
}
```

## 權重計算

### 機率計算公式
```
圖片出現機率 = 圖片權重 / 總權重
```

### 範例
- 圖片1權重：3
- 圖片2-6權重：各1
- 總權重：3 + 1 + 1 + 1 + 1 + 1 = 8
- 圖片1出現機率：3/8 = 37.5%
- 其他圖片出現機率：1/8 = 12.5%

## 調試功能

### 控制台函數
在遊戲中按 F12 開啟開發者工具，可以使用以下函數：

```javascript
// 顯示地圖權重統計
showMapWeightStats()

// 顯示地圖圖片載入狀態
debugMapImages()

// 顯示出口位置信息
showExitInfo()
```

### 測試頁面
開啟 `test-weight.html` 可以進行權重選擇的測試和驗證。

## 技術實現

### 核心函數
1. `loadMapImages()` - 載入地圖圖片和權重
2. `selectWeightedTileIndex()` - 根據權重選擇圖片索引
3. `generateMapLayout()` - 生成地圖佈局

### 隨機種子算法
使用改進的線性同餘生成器確保可重現且隨機性更好的結果：

#### 種子生成
```javascript
const seed = (row * 73856093) ^ (col * 19349663) ^ (level * 83492791);
```

#### 隨機數生成
```javascript
let randomValue = seed;
// 多次迭代來增加隨機性
for (let i = 0; i < 5; i++) {
    randomValue = (randomValue * 9301 + 49297) % 233280;
}
const normalizedRandom = randomValue / 233280;
```

這個改進的算法解決了相鄰位置產生相似隨機數的問題，確保地圖看起來更隨機自然。

## 使用建議

### 1. 主要圖片
- 設定較高的權重（如 3-5）
- 用於主要的地圖元素或主題圖片

### 2. 次要圖片
- 設定較低的權重（如 1-2）
- 用於增加地圖變化性

### 3. 特殊圖片
- 設定最低權重（如 1）
- 用於特殊或罕見的地圖元素

## 範例配置

### 第1關配置
```json
{
  "name": "新手關卡",
  "mapTiles": [
    {
      "path": "assets/maps/map-level1-1.png",
      "weight": 3
    },
    {
      "path": "assets/maps/map-level1-2.png",
      "weight": 1
    },
    {
      "path": "assets/maps/map-level1-3.png",
      "weight": 1
    },
    {
      "path": "assets/maps/map-level1-4.png",
      "weight": 1
    },
    {
      "path": "assets/maps/map-level1-5.png",
      "weight": 1
    },
    {
      "path": "assets/maps/map-level1-6.png",
      "weight": 1
    }
  ]
}
```

這個配置會讓第一張圖片出現的機率是其他圖片的3倍，創造出更豐富的地圖變化。

## 注意事項

1. **圖片檔案**：確保所有圖片檔案都存在且格式正確
2. **權重值**：建議使用正整數，避免使用0或負數
3. **總權重**：避免總權重過大，可能影響性能
4. **測試**：修改權重後建議使用測試頁面驗證效果

## 更新日誌

- **v1.0.0** - 初始版本，支援基本權重選擇
- **v1.1.0** - 添加統計功能和調試工具
- **v1.2.0** - 優化權重算法，提升性能
- **v1.3.0** - 改進隨機種子算法，解決連續相同圖片的問題 